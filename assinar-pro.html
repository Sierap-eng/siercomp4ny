<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade PRO - SierCompany</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        .check-list li { display: flex; align-items: start; gap: 10px; margin-bottom: 12px; font-size: 14px; color: #374151; }
        .modal-fundo { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99; display:none; justify-content:center; align-items:center; }
        .riscado { text-decoration: line-through; color: #9ca3af; font-size: 1.5rem; }
        .crop-container { max-height: 50vh; overflow: hidden; background: #000; display: flex; justify-content: center; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-10 px-4 font-sans">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
        <div class="bg-[#111111] p-6 text-center">
            <h1 class="text-xl font-bold text-white mb-1">Seja <span class="text-[#D4AF37]">PARCEIRO PRO</span></h1>
            <p class="text-gray-400 text-xs">Venda muito mais com ferramentas exclusivas</p>
        </div>

        <div class="p-6 bg-yellow-50/50">
            <h3 class="font-bold text-gray-800 mb-4 ml-1">O que vocÃª ganha:</h3>
            <ul class="check-list">
                <li><i data-lucide="crown" class="w-5 h-5 text-[#D4AF37] fill-current"></i> <div><strong>Destaque Ouro:</strong> Sua loja no topo.</div></li>
                <li><i data-lucide="message-circle" class="w-5 h-5 text-green-500"></i> <div><strong>WhatsApp Liberado:</strong> Contato direto.</div></li>
                <li><i data-lucide="map-pin" class="w-5 h-5 text-blue-500"></i> <div><strong>Mapa Interativo:</strong> LocalizaÃ§Ã£o exata.</div></li>
                <li><i data-lucide="images" class="w-5 h-5 text-purple-500"></i> <div><strong>Galeria e Links:</strong> Fotos e Instagram liberados.</div></li>
            </ul>
        </div>

        <div id="boxUpsell" class="hidden px-6 pb-2 border-t border-gray-100 pt-4">
            <label class="flex items-center gap-3 p-4 border-2 border-purple-100 bg-purple-50 rounded-xl cursor-pointer hover:border-purple-300 transition-all mb-4">
                <input type="checkbox" id="checkBanner" onchange="toggleBannerUpload()" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                <div class="flex-1">
                    <p class="font-bold text-purple-900 text-sm">Adicionar Banner no Topo</p>
                    <p class="text-xs text-purple-600" id="txtValorBanner">+ R$ ...</p>
                </div>
                <i data-lucide="rocket" class="w-5 h-5 text-purple-500"></i>
            </label>

            <div id="areaUploadBanner" class="hidden bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300 text-center">
                <p class="text-xs font-bold text-gray-500 mb-2">Sua imagem aparecerÃ¡ no topo do site</p>
                <button onclick="document.getElementById('fileBanner').click()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-100 w-full mb-2">
                    <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i> Escolher Imagem
                </button>
                <input type="file" id="fileBanner" accept="image/*" class="hidden" onchange="abrirRecorte(this)">
                <img id="previewBanner" class="w-full h-20 object-cover rounded hidden border border-gray-300 shadow-sm">
                <p id="statusBanner" class="text-[10px] text-red-500 mt-1 hidden">ObrigatÃ³rio escolher uma imagem</p>
                
                <input type="text" id="linkBanner" placeholder="Link de destino (Ex: Seu WhatsApp)" class="w-full p-2 mt-2 border rounded text-xs">
            </div>
        </div>

        <div class="p-8 text-center border-t border-gray-100">
            <div id="areaPreco">
                <p class="text-gray-500 text-sm font-medium uppercase">Total a Pagar</p>
                <div class="flex justify-center items-baseline my-2">
                    <span class="text-xl text-gray-500 mr-1">R$</span>
                    <span class="text-5xl font-black text-gray-900 transition-all" id="valorDisplay">...</span>
                </div>
            </div>

            <button onclick="acaoBotao()" id="btnPagar" disabled class="w-full mt-4 bg-[#D4AF37] hover:bg-[#b5952f] text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center gap-2 items-center text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Carregando...
            </button>
            <a href="index.html" class="block text-center text-gray-400 text-xs mt-4 hover:text-gray-600">Voltar para Vitrine</a>
        </div>
    </div>

    <div id="modal-pix" class="modal-fundo">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-[90%] relative shadow-2xl animate-fade-in">
            <button onclick="document.getElementById('modal-pix').style.display='none'" class="absolute top-3 right-3 text-gray-400"><i data-lucide="x"></i></button>
            <div class="text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-1">Pagamento via Pix</h3>
                <p class="text-sm text-gray-500 mb-4" id="descPix">Plano PRO</p>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-left text-xs">
                    <p class="font-bold text-yellow-800 mb-1">DADOS:</p>
                    <p><strong>Nome:</strong> Erica Rios Oliveira Dias</p>
                    <p><strong>Banco:</strong> Cora SCD</p>
                    <p><strong>Chave:</strong> CNPJ (Abaixo)</p>
                </div>
                <div class="flex justify-center mb-4 p-2 border rounded"><div id="qrcode"></div></div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="pixCopiaCola" readonly class="w-full text-xs bg-gray-100 border p-2 rounded truncate">
                    <button onclick="copiarPix()" class="bg-blue-600 text-white px-3 rounded font-bold"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>
                <a id="btnZap" href="#" target="_blank" class="block w-full bg-green-500 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-green-600">
                    <i data-lucide="message-circle" class="w-4 h-4"></i> Enviar Comprovante
                </a>
            </div>
        </div>
    </div>

    <div id="modal-crop" class="modal-fundo">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-2">Ajustar Banner</h3>
            <div class="crop-container"><img id="image-to-crop" style="max-width: 100%;"></div>
            <div class="flex gap-2 mt-4">
                <button onclick="fecharModal()" class="w-1/2 bg-gray-200 py-3 rounded-lg font-bold">Cancelar</button>
                <button onclick="confirmarRecorte()" class="w-1/2 bg-blue-600 text-white py-3 rounded-lg font-bold">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // âš ï¸ COLE SUAS CHAVES AQUI
        const URL_API = 'https://zjtnlyjrxkwybqesszyd.supabase.co';
        const KEY_API = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdG5seWpyeGt3eWJxZXNzenlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzAwNDQsImV4cCI6MjA4NTE0NjA0NH0.1VxX3-qsFhZK9iRfNrofqQT28l0j9F2dfOmC4RR0CpY';
        const client = supabase.createClient(URL_API, KEY_API);

        const PIX_CHAVE="35703153000180"; const PIX_NOME="Erica Rios Oliveira Dias"; const PIX_CIDADE="Salvador"; const MEU_ZAP="55719999466243";

        let precoBase=49.90, precoBanner=49.90, total=49.90;
        let isPromo=false, promoTitulo="", promoRotulo="", promoPreco=0;
        let blobBanner = null, cropper = null;

        async function carregarDados() {
            try {
                const [cfgUpsell, cfgPromo, precos, cfgTitulo, cfgRotulo] = await Promise.all([
                    client.from('config').select('ativo').eq('chave', 'upsell_banner').single(),
                    client.from('config').select('ativo').eq('chave', 'modo_lancamento').single(),
                    client.from('precos').select('*'),
                    client.from('config').select('valor_texto').eq('chave', 'promo_titulo').single(),
                    client.from('config').select('valor_texto').eq('chave', 'promo_rotulo').single()
                ]);

                if(precos.data) {
                    precos.data.forEach(p => {
                        if(p.chave==='plano_pro') precoBase=parseFloat(p.valor);
                        if(p.chave==='banner_30d') precoBanner=parseFloat(p.valor); // Upsell padrÃ£o: 30 dias
                        if(p.chave==='promo_preco') promoPreco=parseFloat(p.valor);
                    });
                }

                promoTitulo = (cfgTitulo.data && cfgTitulo.data.valor_texto) ? cfgTitulo.data.valor_texto : "Oferta Especial";
                promoRotulo = (cfgRotulo.data && cfgRotulo.data.valor_texto) ? cfgRotulo.data.valor_texto : "GRÃTIS";
                isPromo = cfgPromo.data ? cfgPromo.data.ativo : false;
                
                const btn = document.getElementById('btnPagar');
                
                if (isPromo) {
                    const displayPreco = promoPreco > 0 ? `R$ ${promoPreco.toFixed(2).replace('.',',')}` : promoRotulo;
                    document.getElementById('areaPreco').innerHTML = `<p class="text-green-600 text-xs font-bold uppercase bg-green-100 px-3 py-1 rounded-full w-fit mx-auto mb-2">ðŸŽ‰ ${promoTitulo}</p><div class="flex flex-col justify-center items-center"><span class="riscado mb-[-10px]">R$ ${precoBase.toFixed(2).replace('.',',')}</span><span class="text-5xl font-black text-green-600">${displayPreco}</span></div>`;
                    
                    btn.disabled = false;
                    btn.innerHTML = promoPreco > 0 ? `PAGAR COM DESCONTO <i data-lucide="qr-code" class="w-5 h-5 ml-2"></i>` : `LIBERAR ACESSO <i data-lucide="check-circle" class="w-5 h-5 ml-2"></i>`;
                    btn.className = "w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center gap-2 items-center text-lg";
                    document.getElementById('boxUpsell').classList.add('hidden');
                } else {
                    document.getElementById('valorDisplay').innerText = precoBase.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    if (cfgUpsell.data && cfgUpsell.data.ativo) {
                        document.getElementById('boxUpsell').classList.remove('hidden');
                        document.getElementById('txtValorBanner').innerText = `+ R$ ${precoBanner.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    }
                    btn.disabled = false;
                    btn.innerHTML = `PAGAR AGORA <i data-lucide="qr-code" class="w-5 h-5 ml-2"></i>`;
                }
                calcularTotal();
            } catch (error) { console.log("Erro load", error); }
        }

        // --- LÃ“GICA DO UPSELL COM UPLOAD ---
        window.toggleBannerUpload = function() {
            const check = document.getElementById('checkBanner');
            const area = document.getElementById('areaUploadBanner');
            if(check.checked) {
                area.classList.remove('hidden');
            } else {
                area.classList.add('hidden');
                blobBanner = null; // Limpa se desmarcar
                document.getElementById('previewBanner').classList.add('hidden');
            }
            calcularTotal();
        }

        window.calcularTotal = function() {
            if(isPromo) return; 
            const temBanner = document.getElementById('checkBanner').checked;
            total = temBanner ? (precoBase + precoBanner) : precoBase;
            document.getElementById('valorDisplay').innerText = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }

        // --- CROPPER (IGUAL AO ANUNCIAR.HTML) ---
        window.abrirRecorte = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modal-crop').style.display = 'flex';
                    const img = document.getElementById('image-to-crop'); img.src = e.target.result;
                    setTimeout(() => { if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: 3/1, viewMode: 1, autoCropArea: 1 }); }, 100);
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        window.confirmarRecorte = function() {
            if(!cropper) return;
            cropper.getCroppedCanvas({ width: 1200 }).toBlob(b => {
                blobBanner = b;
                document.getElementById('previewBanner').src = URL.createObjectURL(b);
                document.getElementById('previewBanner').classList.remove('hidden');
                document.getElementById('statusBanner').classList.add('hidden');
                fecharModal();
            }, 'image/jpeg', 0.85);
        }
        window.fecharModal = function() { document.getElementById('modal-crop').style.display = 'none'; if(cropper) { cropper.destroy(); cropper = null; } }

        // --- AÃ‡ÃƒO FINAL ---
        window.acaoBotao = async function() {
            const btn = document.getElementById('btnPagar');
            const originalText = btn.innerHTML;
            
            // Verifica PromoÃ§Ã£o GrÃ¡tis
            if (isPromo && promoPreco === 0) {
                const msg = `OlÃ¡! Fiz meu cadastro na promoÃ§Ã£o *${promoTitulo}* (${promoRotulo}). Pode liberar meu acesso PRO?`;
                window.location.href = `https://wa.me/${MEU_ZAP}?text=${encodeURIComponent(msg)}`;
                return;
            }

            // Verifica Upsell (Se marcou, TEM que ter foto)
            const temBanner = document.getElementById('checkBanner').checked;
            if (!isPromo && temBanner && !blobBanner) {
                document.getElementById('statusBanner').classList.remove('hidden');
                alert("VocÃª marcou o Banner! Por favor, escolha a imagem do seu anÃºncio.");
                return;
            }

            btn.disabled = true; btn.innerText = "Processando...";

            try {
                // Se tem banner, sobe pro banco AGORA
                if (!isPromo && temBanner && blobBanner) {
                    const nomeArq = `upsell_${Date.now()}.jpg`;
                    const { error: errUp } = await client.storage.from('sier-images').upload(nomeArq, blobBanner);
                    if(errUp) throw errUp;
                    
                    const { data: urlData } = client.storage.from('sier-images').getPublicUrl(nomeArq);
                    const linkDest = document.getElementById('linkBanner').value;
                    const hoje = new Date(); 
                    hoje.setDate(hoje.getDate() + 30); // Upsell padrÃ£o Ã© 30 dias

                    // SALVA NO BANCO (STATUS PENDENTE)
                    await client.from('banners').insert([{
                        imagem_url: urlData.publicUrl,
                        link_destino: linkDest,
                        nome_cliente: "Upsell Checkout",
                        plano_dias: 30,
                        status: 'pendente',
                        data_expiracao: hoje.toISOString()
                    }]);
                }

                // Gera o Pix
                abrirPagamento();
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (err) {
                alert("Erro ao salvar banner: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function abrirPagamento() {
            document.getElementById('modal-pix').style.display = 'flex';
            document.getElementById('qrcode').innerHTML = "";
            
            const desc = isPromo ? `Promo: ${promoTitulo}` : (document.getElementById('checkBanner').checked ? "Plano PRO + Banner" : "Plano PRO");
            document.getElementById('descPix').innerText = desc;
            
            const payload = gerarPayloadPix(PIX_CHAVE, PIX_NOME, PIX_CIDADE, total.toFixed(2), "SIERPRO");
            setTimeout(() => { new QRCode(document.getElementById("qrcode"), { text: payload, width: 160, height: 160 }); }, 100);
            document.getElementById('pixCopiaCola').value = payload;
            
            const msg = `OlÃ¡! Fiz o pagamento de *${desc}* (R$ ${total.toFixed(2)}). Segue o comprovante:`;
            document.getElementById('btnZap').href = `https://wa.me/${MEU_ZAP}?text=${encodeURIComponent(msg)}`;
        }

        function copiarPix() { const el = document.getElementById("pixCopiaCola"); el.select(); el.setSelectionRange(0,99999); navigator.clipboard.writeText(el.value); alert("Copiado!"); }
        function gerarPayloadPix(chave, nome, cidade, valor, txtId) { const nomeT = nome.substring(0,25).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const cidadeT = cidade.substring(0,15).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const val = valor.toString(); const merchant = `0014BR.GOV.BCB.PIX01${chave.length}${chave}`; let p = `00020126${merchant.length}${merchant}520400005303986540${val.length}${val}5802BR59${(nomeT.length<10?'0':'')+nomeT.length}${nomeT}60${(cidadeT.length<10?'0':'')+cidadeT.length}${cidadeT}62070503***6304`; return p + crc16(p); }
        function crc16(buffer) { let crc = 0xFFFF; for (let i = 0; i < buffer.length; i++) { crc = ((crc >>> 8) | (crc << 8)) & 0xffff; crc ^= (buffer.charCodeAt(i) & 0x00ff); crc ^= ((crc & 0xff) >> 4); crc ^= (crc << 12) & 0xffff; crc ^= ((crc & 0xFF) << 5) & 0xffff; } return crc.toString(16).toUpperCase().padStart(4, '0'); }

        carregarDados();
    </script>
</body>
</html>
  
       
